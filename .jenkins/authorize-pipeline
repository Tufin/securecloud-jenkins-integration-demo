pipeline {
    agent {
        label 'linux-agent'
    }
    environment {
        TMP_DIR="${env.WORKSPACE}" + "/" + "${env.BUILD_NUMBER}"
        TERRAFORM_PLAN_FILE="${env.TERRAFORM_PLAN_FILE}"
        SCW_RESPONSE_FILE="${TMP_DIR}" + "/scw_response.json"
        SC_TARGETS_FILE="${TMP_DIR}" + "/sc_targets.json"
        SC_AUTH_REQUEST_BODY_FILE="${TMP_DIR}" + "/sc_auth_request_body.json"
        SC_AUTH_RESPONSE_FILE="${TMP_DIR}" + "/sc_auth_response.json"
    }
    stages {
        stage('Terraform Change Authorization') {
            steps {
                withCredentials([string(credentialsId: "${SECURECLOUD_JENKINS_CREDENTIALS_ID}", variable: 'TUFIN_SECURECLOUD_API_KEY')]) {
                    withCredentials([usernameColonPassword(credentialsId: "${SECURECHANGE_JENKINS_CREDENTIALS_ID}", variable: 'TUFIN_SECURECHANGE_CREDENTIALS')]) {
                        withFileParameter('uploaded_plan') {
                            script {
                                sh 'mkdir -p "${TMP_DIR}"'
                                sh 'cat $uploaded_plan > uploaded_plan.json'
                                sh 'bash ./scripts/securechange-authorize-change.sh "${SECURECHANGE_TICKET_ID}" "${TERRAFORM_PLAN_FILE}" "${SCW_RESPONSE_FILE}" "${SC_TARGETS_FILE}" "${SC_AUTH_REQUEST_BODY_FILE}" "${SC_AUTH_RESPONSE_FILE}"'
                            }
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            archiveArtifacts artifacts: '"${SCW_RESPONSE_FILE}"'
        }
    }
}
